name: Deploy

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Debug OIDC token claims
        run: |
          resp=$(curl -sSL -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com")
          token=$(echo "$resp" | jq -r '.value')
          payload=$(echo "$token" | cut -d. -f2)
          echo "$payload" | base64 -d 2>/dev/null | jq . || echo "$payload===" | base64 -d | jq .
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      - name: Build frontend
        env:
          VITE_API_BASE_URL: https://5gt1117eh5.execute-api.us-east-1.amazonaws.com
        run: |
          cd frontend
          npm install
          npm run build

      - name: Build Stripe Lambda layer
        run: |
          rm -rf layers/stripe/python
          mkdir -p layers/stripe/python
          python -m pip install -q stripe -t layers/stripe/python
          test -d layers/stripe/python/stripe
          PYTHONPATH=layers/stripe/python python -c "import stripe; print(stripe.VERSION)"
      
      - name: Deploy with CDK
        env:
          SETUP_KEY: ${{ secrets.SETUP_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_PRICE_50GB: ${{ secrets.STRIPE_PRICE_50GB }}
          STRIPE_PRICE_200GB: ${{ secrets.STRIPE_PRICE_200GB }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          STRIPE_SUCCESS_URL: ${{ secrets.STRIPE_SUCCESS_URL }}
          STRIPE_CANCEL_URL: ${{ secrets.STRIPE_CANCEL_URL }}
        run: |
          npm install -g aws-cdk
          cd infra
          python -m pip install -q -r requirements.txt
          cdk deploy --require-approval never
